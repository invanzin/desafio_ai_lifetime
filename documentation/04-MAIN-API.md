# üåê Documenta√ß√£o: Main API (main.py)

## üìö √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura FastAPI](#arquitetura-fastapi)
3. [Middleware](#middleware)
4. [Exception Handlers](#exception-handlers)
5. [Endpoints](#endpoints)
6. [Fluxo de Requisi√ß√£o](#fluxo-de-requisi√ß√£o)
7. [C√≥digos de Status](#c√≥digos-de-status)
8. [Exemplos Pr√°ticos](#exemplos-pr√°ticos)

---

## üéØ Vis√£o Geral

O arquivo `main.py` √© a **porta de entrada** do microservi√ßo. Ele:

‚úÖ Exp√µe endpoints HTTP (FastAPI)  
‚úÖ Valida requisi√ß√µes automaticamente (Pydantic)  
‚úÖ Adiciona Request-ID para rastreamento  
‚úÖ Trata erros de forma robusta  
‚úÖ Gera documenta√ß√£o autom√°tica (Swagger/ReDoc)  
‚úÖ Integra schemas.py + extractor.py

### Por que FastAPI?

**FastAPI** √© um framework web moderno que oferece:

- **Performance:** Baseado em Starlette (ass√≠ncrono)
- **Valida√ß√£o:** Integra√ß√£o nativa com Pydantic
- **Documenta√ß√£o:** OpenAPI/Swagger gerada automaticamente
- **Type Hints:** Verifica√ß√£o de tipos em tempo de desenvolvimento
- **Async/Await:** Suporte nativo a opera√ß√µes ass√≠ncronas

**Compara√ß√£o com Flask (s√≠ncrono):**

```python
# Flask (s√≠ncrono - ‚ùå lento para I/O)
@app.route('/extract', methods=['POST'])
def extract():
    data = request.json
    result = process(data)  # Bloqueia thread
    return result

# FastAPI (ass√≠ncrono - ‚úÖ r√°pido)
@app.post("/extract")
async def extract(body: ExtractRequest):
    result = await process(body)  # N√£o bloqueia
    return result
```

---

## üèóÔ∏è Arquitetura FastAPI

### Estrutura de Camadas

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENTE HTTP                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 1. MIDDLEWARE                        ‚îÇ
‚îÇ              (add_request_id)                        ‚îÇ
‚îÇ  - Adiciona/preserva X-Request-ID                    ‚îÇ
‚îÇ  - Propaga ID em request.state                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           2. VALIDA√á√ÉO (autom√°tica)                  ‚îÇ
‚îÇ  - FastAPI valida body com Pydantic                  ‚îÇ
‚îÇ  - Se inv√°lido ‚Üí 422 (validation_exception_handler)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              3. ENDPOINT HANDLER                     ‚îÇ
‚îÇ              (extract_meeting)                       ‚îÇ
‚îÇ  - Normaliza dados                                   ‚îÇ
‚îÇ  - Chama extractor                                   ‚îÇ
‚îÇ  - Retorna resultado                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            4. EXCEPTION HANDLERS                     ‚îÇ
‚îÇ  - OpenAI errors ‚Üí 502                               ‚îÇ
‚îÇ  - Validation errors ‚Üí 422                           ‚îÇ
‚îÇ  - Outros erros ‚Üí 500                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 RESPOSTA HTTP                        ‚îÇ
‚îÇ  - JSON estruturado                                  ‚îÇ
‚îÇ  - Header X-Request-ID                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Middleware

### `add_request_id` - Rastreamento de Requisi√ß√µes

```python
@app.middleware("http")
async def add_request_id(request: Request, call_next):
    """
    Middleware que adiciona um X-Request-ID √∫nico a cada requisi√ß√£o.
    
    Usado para correla√ß√£o de logs e debugging. Se o cliente j√° enviar
    um X-Request-ID, ele √© preservado; caso contr√°rio, um novo UUID √© gerado.
    """
    request_id = request.headers.get("X-Request-ID", str(uuid.uuid4()))
    request.state.request_id = request_id
    
    response = await call_next(request)
    response.headers["X-Request-ID"] = request_id
    
    return response
```

### Como Funciona?

**Sequ√™ncia de Execu√ß√£o:**

```
1. Requisi√ß√£o chega
   ‚Üì
2. Middleware intercepta
   ‚Üì
3. Verifica header X-Request-ID
   ‚îú‚îÄ Se presente: usa o ID do cliente
   ‚îî‚îÄ Se ausente: gera novo UUID v4
   ‚Üì
4. Salva em request.state.request_id
   ‚Üì
5. Chama pr√≥xima camada (call_next)
   ‚Üì
6. Adiciona X-Request-ID no header de resposta
   ‚Üì
7. Retorna resposta
```

**Exemplo de Requisi√ß√£o:**

```http
POST /extract HTTP/1.1
X-Request-ID: meu-id-customizado
Content-Type: application/json

{...}
```

**Resposta:**

```http
HTTP/1.1 200 OK
X-Request-ID: meu-id-customizado
Content-Type: application/json

{...}
```

**Sem X-Request-ID fornecido:**

```http
POST /extract HTTP/1.1
Content-Type: application/json

{...}
```

**Resposta (com UUID gerado):**

```http
HTTP/1.1 200 OK
X-Request-ID: a3f2c8b1-e4d7-4a2f-b1c9-8e5f6d7a9b2c
Content-Type: application/json

{...}
```

### Por que usar request.state?

```python
# ‚úÖ BOM - request.state √© thread-safe e isolado por request
request.state.request_id = "abc-123"

# ‚ùå RUIM - vari√°vel global pode causar race conditions
global_request_id = "abc-123"
```

---

## üö® Exception Handlers

FastAPI permite capturar exce√ß√µes espec√≠ficas e retornar respostas customizadas.

### 1. `validation_exception_handler` - Erro 422

Trata erros de valida√ß√£o do Pydantic quando o body da requisi√ß√£o √© inv√°lido:

```python
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(
    request: Request, 
    exc: RequestValidationError
) -> JSONResponse:
    """Handler para erros de valida√ß√£o do Pydantic (422 Unprocessable Entity)."""
    request_id = getattr(request.state, "request_id", "-")
    
    # Serializa os erros de valida√ß√£o de forma segura
    errors = []
    for error in exc.errors():
        errors.append({
            "loc": error.get("loc", []),      # Localiza√ß√£o do erro
            "msg": str(error.get("msg", "")), # Mensagem leg√≠vel
            "type": error.get("type", ""),    # Tipo de erro
        })
    
    logger.warning(
        f"[{request_id}] Validation error | "
        f"errors={errors}"
    )
    
    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content={
            "error": "validation_error",
            "message": "Dados de entrada inv√°lidos",
            "details": errors,
            "request_id": request_id,
        }
    )
```

**Quando √© ativado:**

```python
# Cliente envia JSON inv√°lido
{
    "transcript": "...",
    "raw_meeting": {...}  # ‚ùå Ambos fornecidos (erro!)
}

# FastAPI valida contra ExtractRequest
# ExtractRequest.validate_exclusive_fields() lan√ßa ValueError
# Handler captura e retorna:
```

**Resposta:**

```json
{
  "error": "validation_error",
  "message": "Dados de entrada inv√°lidos",
  "details": [
    {
      "loc": ["body"],
      "msg": "Value error, Forne√ßa 'transcript' OU 'raw_meeting', n√£o ambos nem nenhum",
      "type": "value_error"
    }
  ],
  "request_id": "abc-123"
}
```

### 2. `generic_exception_handler` - Erro 500

Captura **qualquer exce√ß√£o n√£o tratada** e retorna uma resposta gen√©rica:

```python
@app.exception_handler(Exception)
async def generic_exception_handler(
    request: Request,
    exc: Exception
) -> JSONResponse:
    """Handler gen√©rico para exce√ß√µes n√£o tratadas (500 Internal Server Error)."""
    request_id = getattr(request.state, "request_id", "-")
    
    logger.error(
        f"[{request_id}] Unhandled exception | "
        f"type={type(exc).__name__} | "
        f"error={str(exc)[:200]}"
    )
    
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "internal_server_error",
            "message": "Erro interno do servidor",
            "request_id": request_id,
        }
    )
```

**Por que um handler gen√©rico?**

- ‚úÖ Evita expor detalhes internos sens√≠veis ao cliente
- ‚úÖ Garante que sempre h√° uma resposta estruturada
- ‚úÖ Loga erros inesperados para debugging
- ‚úÖ Melhora a experi√™ncia do usu√°rio (mensagem clara)

**Sem handler gen√©rico:**

```json
{
  "detail": "AttributeError: 'NoneType' object has no attribute 'split'"
}
```

**Com handler gen√©rico:**

```json
{
  "error": "internal_server_error",
  "message": "Erro interno do servidor",
  "request_id": "abc-123"
}
```

---

## üì° Endpoints

### 1. `GET /health` - Health Check

**Prop√≥sito:** Verificar se o servi√ßo est√° funcionando.

```python
@app.get("/health", tags=["Health"])
async def health_check() -> Dict[str, str]:
    """Health check endpoint."""
    return {
        "status": "healthy",
        "service": "meeting-extractor",
    }
```

**Uso t√≠pico:**

- Load balancers (verificar se inst√¢ncia est√° saud√°vel)
- Kubernetes liveness/readiness probes
- Monitoramento (Datadog, New Relic, etc)
- CI/CD pipelines (verificar deploy bem-sucedido)

**Exemplo:**

```bash
curl http://localhost:8000/health

# Resposta:
{
  "status": "healthy",
  "service": "meeting-extractor"
}
```

---

### 2. `POST /extract` - Extra√ß√£o de Informa√ß√µes

**Prop√≥sito:** Extrair informa√ß√µes estruturadas de uma transcri√ß√£o.

```python
@app.post(
    "/extract",
    response_model=ExtractedMeeting,
    status_code=status.HTTP_200_OK,
    tags=["Extraction"],
    summary="Extrai informa√ß√µes estruturadas de uma transcri√ß√£o",
    response_description="Informa√ß√µes estruturadas extra√≠das com sucesso"
)
async def extract_meeting(
    request: Request,
    body: ExtractRequest
) -> ExtractedMeeting:
    """Extrai informa√ß√µes estruturadas de uma transcri√ß√£o de reuni√£o."""
```

#### Par√¢metros do Decorator

| Par√¢metro | Valor | Prop√≥sito |
|-----------|-------|-----------|
| `response_model` | `ExtractedMeeting` | Define schema de resposta (valida√ß√£o + docs) |
| `status_code` | `200` | C√≥digo HTTP padr√£o de sucesso |
| `tags` | `["Extraction"]` | Agrupa endpoints na documenta√ß√£o |
| `summary` | "Extrai..." | T√≠tulo curto no Swagger |
| `response_description` | "Informa√ß√µes..." | Descri√ß√£o da resposta no Swagger |

#### Fluxo Interno do Endpoint

```python
request_id = request.state.request_id  # Obtido do middleware

# Log in√≠cio (sem PII completa)
logger.info(
    f"[{request_id}] POST /extract | "
    f"format={'raw_meeting' if body.raw_meeting else 'transcript+metadata'}"
)

try:
    # 1Ô∏è‚É£ Normalizar input
    normalized = body.to_normalized()
    
    logger.info(
        f"[{request_id}] Input normalizado | "
        f"transcript_len={len(normalized.transcript)} | "
        f"has_metadata={normalized.meeting_id is not None}"
    )
    
    # 2Ô∏è‚É£ Chamar o extractor (LangChain + OpenAI)
    extracted = await extract_meeting_chain(
        normalized=normalized,
        request_id=request_id
    )
    
    # 3Ô∏è‚É£ Log sucesso
    logger.info(
        f"[{request_id}] Extra√ß√£o conclu√≠da com sucesso | "
        f"meeting_id={extracted.meeting_id} | "
        f"idempotency_key={extracted.idempotency_key[:16]}..."
    )
    
    return extracted
    
except (RateLimitError, APITimeoutError, APIError) as e:
    # Erros da OpenAI API ‚Üí retornar 502 Bad Gateway
    logger.error(
        f"[{request_id}] Erro na OpenAI API | "
        f"type={type(e).__name__} | "
        f"error={str(e)[:200]}"
    )
    
    return JSONResponse(
        status_code=status.HTTP_502_BAD_GATEWAY,
        content={
            "error": "openai_api_error",
            "message": (
                "Erro ao comunicar com OpenAI API. "
                "Tente novamente em alguns instantes."
            ),
            "error_type": type(e).__name__,
            "request_id": request_id,
        }
    )

except ValidationError as e:
    # Erro de valida√ß√£o Pydantic no output do LLM (ap√≥s repair)
    logger.error(
        f"[{request_id}] Valida√ß√£o do output falhou ap√≥s repair | "
        f"errors={e.errors()}"
    )
    
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "llm_output_validation_error",
            "message": (
                "N√£o foi poss√≠vel extrair informa√ß√µes v√°lidas da transcri√ß√£o. "
                "Por favor, verifique se a transcri√ß√£o est√° leg√≠vel."
            ),
            "request_id": request_id,
        }
    )

except Exception as e:
    # Qualquer outro erro n√£o previsto
    logger.error(
        f"[{request_id}] Erro inesperado | "
        f"type={type(e).__name__} | "
        f"error={str(e)[:200]}"
    )
    
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "internal_error",
            "message": "Erro interno ao processar a requisi√ß√£o",
            "request_id": request_id,
        }
    )
```

---

### üö® Tratamento de Erros Espec√≠ficos do `/extract`

O endpoint `/extract` possui **3 tipos de erro espec√≠ficos** al√©m dos handlers globais:

#### **1. OpenAI Communication Error ‚Üí 502 Bad Gateway**

**Quando acontece:**
- ‚è±Ô∏è **Rate limit da OpenAI atingido** - Muitas requisi√ß√µes em pouco tempo
- ‚è∞ **Timeout (>30s)** - Chamada para OpenAI demorou muito
- üîå **API da OpenAI fora do ar** - Indisponibilidade do servi√ßo OpenAI

**Por que 502?** √â um problema de **comunica√ß√£o** com servi√ßo externo (upstream).

**C√≥digo (linhas 369-389 do main.py):**
```python
except (RateLimitError, APITimeoutError, APIError) as e:
    logger.error(
        f"[{request_id}] Erro de comunica√ß√£o com OpenAI API | "
        f"type={type(e).__name__}"
    )
    return JSONResponse(
        status_code=status.HTTP_502_BAD_GATEWAY,
        content={
            "error": "openai_communication_error",
            "message": "Erro ao comunicar com OpenAI API (timeout, rate limit ou indisponibilidade). "
                      "Tente novamente em alguns instantes.",
            "error_type": type(e).__name__,
            "request_id": request_id,
        }
    )
```

**Resposta:** Pede para o cliente tentar novamente mais tarde

**Exemplo de resposta:**
```json
{
  "error": "openai_communication_error",
  "message": "Erro ao comunicar com OpenAI API (timeout, rate limit ou indisponibilidade). Tente novamente em alguns instantes.",
  "error_type": "RateLimitError",
  "request_id": "abc-123"
}
```

**Log correspondente:**
```
[abc-123] Erro de comunica√ß√£o com OpenAI API | type=RateLimitError | error=Rate limit exceeded...
```

---

#### **2. OpenAI Invalid Response ‚Üí 502 Bad Gateway**

**Quando acontece:**
- ü§ñ **OpenAI retornou dados inv√°lidos** mesmo ap√≥s tentativa de reparo autom√°tico
- üìù **Transcri√ß√£o muito confusa** - IA n√£o conseguiu extrair informa√ß√µes no formato correto
- ‚ùå **Summary fora do padr√£o** - N√£o tem 100-200 palavras
- üîß **Campos obrigat√≥rios faltando** na resposta da IA

**Por que 502?** √â um problema do **conte√∫do retornado** pelo servi√ßo externo (OpenAI), n√£o um bug interno.

**C√≥digo (linhas 391-409 do main.py):**
```python
except ValidationError as e:
    # Erro de valida√ß√£o: OpenAI retornou dados inv√°lidos ‚Üí 502 Bad Gateway
    # Este √© um problema do servi√ßo externo (OpenAI), n√£o interno
    logger.error(
        f"[{request_id}] OpenAI retornou dados inv√°lidos ap√≥s repair | "
        f"errors={e.errors()}"
    )
    return JSONResponse(
        status_code=status.HTTP_502_BAD_GATEWAY,
        content={
            "error": "openai_invalid_response",
            "message": "OpenAI retornou dados inv√°lidos ou incompletos. "
                      "Tente novamente ou verifique se a transcri√ß√£o est√° leg√≠vel.",
            "request_id": request_id,
        }
    )
```

**Resposta:** Sugere tentar novamente ou verificar a transcri√ß√£o

**Exemplo de resposta:**
```json
{
  "error": "openai_invalid_response",
  "message": "OpenAI retornou dados inv√°lidos ou incompletos. Tente novamente ou verifique se a transcri√ß√£o est√° leg√≠vel.",
  "request_id": "xyz-789"
}
```

**Log correspondente:**
```
[xyz-789] OpenAI retornou dados inv√°lidos ap√≥s repair | errors=[{'loc': ['summary'], 'msg': 'summary deve ter 100-200 palavras, tem 45'}]
```

---

#### **3. Erro Gen√©rico/Inesperado ‚Üí 500 Internal Server Error**

**Quando acontece:**
- üí• **Qualquer outro erro n√£o previsto** no c√≥digo
- üêõ **Bug n√£o mapeado** na aplica√ß√£o
- üîß **Problema de infraestrutura** (mem√≥ria, disco, etc)

**Por que 500?** √â um problema **interno da aplica√ß√£o**, n√£o do servi√ßo externo.

**C√≥digo (linhas 411-424 do main.py):**
```python
except Exception as e:
    logger.error(
        f"[{request_id}] Erro inesperado | "
        f"type={type(e).__name__}"
    )
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "internal_error",
            "message": "Erro interno ao processar a requisi√ß√£o",
            "request_id": request_id,
        }
    )
```

**Resposta:** Mensagem gen√©rica (n√£o exp√µe detalhes internos por seguran√ßa)

**Exemplo de resposta:**
```json
{
  "error": "internal_error",
  "message": "Erro interno ao processar a requisi√ß√£o",
  "request_id": "def-456"
}
```

**Log correspondente:**
```
[def-456] Erro inesperado | type=AttributeError | error='NoneType' object has no attribute 'split'
```

---

### üìä Tabela Resumo: Erros do `/extract`

| Erro | Status | Causa | A√ß√£o do Cliente | Retry? |
|------|--------|-------|-----------------|--------|
| `openai_communication_error` | **502** | Timeout/rate limit/indisponibilidade | ‚è∞ Tentar novamente em alguns segundos | ‚úÖ Sim |
| `openai_invalid_response` | **502** | OpenAI retornou dados inv√°lidos | üîÑ Tentar novamente ou verificar transcri√ß√£o | ‚úÖ Sim |
| `internal_error` | **500** | Bug ou problema de infraestrutura | üîç Reportar com Request-ID para debug | ‚ùå N√£o |

---

### üéØ Por que 502 para ambos os erros da OpenAI?

**L√≥gica:** O c√≥digo HTTP **502 (Bad Gateway)** significa "problema com servi√ßo upstream". Ambos os casos s√£o problemas causados pela OpenAI:

1. **Communication Error:** A conex√£o/rede com OpenAI falhou
2. **Invalid Response:** A OpenAI n√£o conseguiu gerar dados v√°lidos

**Diferencia√ß√£o:** Mesmo sendo o mesmo status code (502), voc√™ consegue diferenciar pelos:
- ‚úÖ **Logs:** Mensagens diferentes (`Erro de comunica√ß√£o` vs `retornou dados inv√°lidos`)
- ‚úÖ **Campo `error`:** `openai_communication_error` vs `openai_invalid_response`
- ‚úÖ **Campo `error_type`:** Presente apenas no erro de comunica√ß√£o (ex: `RateLimitError`)

**Vantagens:**
- ‚úÖ Cliente sabe que pode fazer **retry** em ambos os casos (problema externo)
- ‚úÖ Diferencia de **500** (problema interno ‚Üí n√£o adianta retry)
- ‚úÖ Monitoramento pode rastrear "problemas com OpenAI" vs "bugs nossos"

---

### üìä Estrutura Completa de Status Codes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              STATUS CODE                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  200 - Sucesso                                   ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  422 - Problema no INPUT do cliente              ‚îÇ
‚îÇ       ‚Üí validation_error                         ‚îÇ
‚îÇ       ‚Üí ‚ùå N√£o retry                             ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  502 - Problema com OpenAI (externo)             ‚îÇ
‚îÇ       ‚Üí openai_communication_error               ‚îÇ
‚îÇ          (timeout, rate limit, indispon√≠vel)     ‚îÇ
‚îÇ       ‚Üí openai_invalid_response                  ‚îÇ
‚îÇ          (dados inv√°lidos/incompletos)           ‚îÇ
‚îÇ       ‚Üí ‚úÖ Retry recomendado                     ‚îÇ
‚îÇ                                                  ‚îÇ
‚îÇ  500 - Problema interno da aplica√ß√£o             ‚îÇ
‚îÇ       ‚Üí internal_error                           ‚îÇ
‚îÇ          (bug, infraestrutura)                   ‚îÇ
‚îÇ       ‚Üí ‚ùå N√£o retry                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### üîç Diferencia√ß√£o Detalhada dos Erros 502

| M√©todo | Erro de Comunica√ß√£o | Erro de Resposta Inv√°lida |
|--------|---------------------|---------------------------|
| **Status HTTP** | 502 | 502 |
| **Campo `error`** | `openai_communication_error` | `openai_invalid_response` |
| **Campo `error_type`** | `RateLimitError` / `APITimeoutError` / `APIError` | ‚ùå Ausente |
| **Log (in√≠cio)** | `Erro de comunica√ß√£o com OpenAI API` | `OpenAI retornou dados inv√°lidos ap√≥s repair` |
| **Causa raiz** | Rede, timeout, rate limit, API fora do ar | LLM gerou resposta inv√°lida ou incompleta |
| **A√ß√£o sugerida** | Aguardar e tentar novamente | Verificar transcri√ß√£o ou tentar novamente |

---

## üîÑ Fluxo de Requisi√ß√£o Completo

### üèóÔ∏è Arquitetura Completa: Vis√£o End-to-End

Este diagrama mostra o fluxo completo desde o cliente at√© a resposta final:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CLIENTE                             ‚îÇ
‚îÇ              (curl, Postman, frontend)                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ HTTP Request (POST /extract)
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   MAIN.PY (FastAPI)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Middleware: Add Request ID                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Gera/preserva X-Request-ID                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Salva em request.state                          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Valida√ß√£o: Pydantic (ExtractRequest)             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Valida formato do JSON                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Verifica campos obrigat√≥rios                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Se inv√°lido ‚Üí 422 Validation Error             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                     ‚Üì                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Endpoint: /extract                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Normaliza input (to_normalized)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Chama extractor                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Logs estruturados                               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              EXTRACTOR (LangChain)                       ‚îÇ
‚îÇ              app/extractors/extractor.py                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  - Monta prompt estruturado                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Chama OpenAI API (com retry/timeout)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Parse resposta JSON                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Repair autom√°tico se JSON inv√°lido              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  OpenAI API                              ‚îÇ
‚îÇ              (GPT-4, GPT-3.5, etc)                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  - Processa transcri√ß√£o                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Extrai: summary, key_points, action_items       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Retorna JSON estruturado                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ JSON estruturado
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Valida√ß√£o Final (Pydantic)                  ‚îÇ
‚îÇ              ExtractedMeeting schema                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  - Valida todos os campos obrigat√≥rios             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Valida summary (100-200 palavras)               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Calcula idempotency_key (SHA-256)               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Se inv√°lido ‚Üí 500 ap√≥s repair                   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ ‚úÖ Validado!
                     ‚Üì Retorna 200 OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CLIENTE                             ‚îÇ
‚îÇ              Recebe JSON estruturado                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  {                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "meeting_id": "MTG123",                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "summary": "...",                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "key_points": [...],                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "action_items": [...],                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "topics": [...],                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    "idempotency_key": "7e3e97..."                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  }                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üéØ Pontos-Chave da Arquitetura

| Componente | Responsabilidade | Falha ‚Üí Status |
|------------|------------------|----------------|
| **Middleware** | Rastreamento (Request-ID) | - |
| **Pydantic (entrada)** | Valida√ß√£o do body | ‚Üí 422 |
| **Endpoint** | Orquestra√ß√£o do fluxo | ‚Üí 500 |
| **Extractor** | Chamada OpenAI + retry | ‚Üí 502 (OpenAI) / 500 (outros) |
| **Pydantic (sa√≠da)** | Valida√ß√£o do resultado | ‚Üí 500 (ap√≥s repair) |

---

### Caso de Sucesso (Happy Path)

```
1. Cliente ‚Üí POST /extract
   {
     "transcript": "Cliente: Ol√°...",
     "metadata": {"meeting_id": "MTG001"}
   }
   ‚Üì
   
2. Middleware: add_request_id
   - Gera UUID: "abc-123"
   - Salva em request.state.request_id
   ‚Üì
   
3. FastAPI: Valida√ß√£o Autom√°tica
   - Valida body contra ExtractRequest (Pydantic)
   - ‚úÖ OK! (formato v√°lido)
   ‚Üì
   
4. Endpoint: extract_meeting
   - Log: "[abc-123] POST /extract | format=transcript+metadata"
   - Normaliza: body.to_normalized()
   - Log: "[abc-123] Input normalizado | transcript_len=790"
   - Chama: extract_meeting_chain()
   ‚Üì
   
5. Extractor: extractor.py
   - Monta prompt
   - Chama OpenAI API
   - Valida com Pydantic
   - Calcula idempotency_key
   - Retorna ExtractedMeeting
   ‚Üì
   
6. Endpoint: extract_meeting (continua√ß√£o)
   - Log: "[abc-123] Extra√ß√£o conclu√≠da | meeting_id=MTG001"
   - Retorna extracted
   ‚Üì
   
7. FastAPI: Serializa√ß√£o
   - Converte ExtractedMeeting ‚Üí JSON
   - Valida contra response_model
   ‚Üì
   
8. Middleware: add_request_id (retorno)
   - Adiciona header: X-Request-ID: abc-123
   ‚Üì
   
9. Cliente ‚Üê 200 OK
   {
     "meeting_id": "MTG001",
     "summary": "...",
     ...
   }
```

---

### Caso de Erro: Valida√ß√£o de Entrada (422)

```
1. Cliente ‚Üí POST /extract
   {
     "transcript": "...",
     "raw_meeting": {...}  # ‚ùå Ambos fornecidos
   }
   ‚Üì
   
2. Middleware: add_request_id
   - request_id = "xyz-789"
   ‚Üì
   
3. FastAPI: Valida√ß√£o Autom√°tica
   - Tenta validar contra ExtractRequest
   - ExtractRequest.validate_exclusive_fields() lan√ßa ValueError
   - ‚ùå FALHA!
   ‚Üì
   
4. Exception Handler: validation_exception_handler
   - Log: "[xyz-789] Validation error | errors=[...]"
   - Retorna JSONResponse(422, {...})
   ‚Üì
   
5. Cliente ‚Üê 422 Unprocessable Entity
   {
     "error": "validation_error",
     "message": "Dados de entrada inv√°lidos",
     "details": [...]
   }
```

---

### Caso de Erro: OpenAI Communication (502)

```
1. Cliente ‚Üí POST /extract (v√°lido)
   ‚Üì
   
2-3. Valida√ß√£o OK
   ‚Üì
   
4. Endpoint: extract_meeting
   - Chama extract_meeting_chain()
   ‚Üì
   
5. Extractor: extractor.py
   - Tenta chamar OpenAI API
   - Tentativa 1: ‚ùå RateLimitError (429)
   - Espera 0.5s...
   - Tentativa 2: ‚ùå RateLimitError (429)
   - Espera 1s...
   - Tentativa 3: ‚ùå RateLimitError (429)
   - Lan√ßa RateLimitError
   ‚Üì
   
6. Endpoint: extract_meeting (catch)
   - Captura RateLimitError
   - Log: "[abc-123] Erro de comunica√ß√£o com OpenAI API | type=RateLimitError"
   - Retorna JSONResponse(502, {...})
   ‚Üì
   
7. Cliente ‚Üê 502 Bad Gateway
   {
     "error": "openai_communication_error",
     "message": "Erro ao comunicar com OpenAI API (timeout, rate limit...)...",
     "error_type": "RateLimitError"
   }
```

---

### Caso de Erro: OpenAI Invalid Response (502)

```
1. Cliente ‚Üí POST /extract (v√°lido)
   ‚Üì
   
2-3. Valida√ß√£o OK
   ‚Üì
   
4. Endpoint: extract_meeting
   - Chama extract_meeting_chain()
   ‚Üì
   
5. Extractor: extractor.py
   - Chama OpenAI API
   - ‚úÖ OpenAI responde com JSON
   - Tenta validar com Pydantic
   - ‚ùå ValidationError (summary tem 45 palavras, precisa 100-200)
   - Tenta repair
   - Chama OpenAI novamente para corrigir
   - ‚ùå Ainda inv√°lido
   - Lan√ßa ValidationError
   ‚Üì
   
6. Endpoint: extract_meeting (catch)
   - Captura ValidationError
   - Log: "[xyz-789] OpenAI retornou dados inv√°lidos ap√≥s repair | errors=[...]"
   - Retorna JSONResponse(502, {...})
   ‚Üì
   
7. Cliente ‚Üê 502 Bad Gateway
   {
     "error": "openai_invalid_response",
     "message": "OpenAI retornou dados inv√°lidos ou incompletos...",
   }
```

---

## üìä C√≥digos de Status HTTP

### Sucesso

| C√≥digo | Nome | Quando Ocorre |
|--------|------|---------------|
| **200** | OK | Extra√ß√£o bem-sucedida |

### Erros do Cliente

| C√≥digo | Nome | Quando Ocorre |
|--------|------|---------------|
| **422** | Unprocessable Entity | Valida√ß√£o de entrada falhou (body JSON inv√°lido) |

### Erros do Servidor

| C√≥digo | Nome | Quando Ocorre |
|--------|------|---------------|
| **502** | Bad Gateway | Problema com OpenAI (comunica√ß√£o ou resposta inv√°lida) |
| **500** | Internal Server Error | Problema interno da aplica√ß√£o (bug ou infraestrutura) |

### Tabela Detalhada

| Status | Erro | Causa | Solu√ß√£o | Retry? |
|--------|------|-------|---------|--------|
| 200 | - | - | ‚úÖ Sucesso | - |
| 422 | `validation_error` | Body JSON mal formatado ou campos inv√°lidos | Verificar formato da requisi√ß√£o | ‚ùå N√£o |
| 502 | `openai_communication_error` | Timeout, rate limit ou OpenAI indispon√≠vel | Tentar novamente em alguns segundos | ‚úÖ Sim |
| 502 | `openai_invalid_response` | OpenAI retornou dados inv√°lidos/incompletos | Tentar novamente ou verificar transcri√ß√£o | ‚úÖ Sim |
| 500 | `internal_error` | Bug no c√≥digo ou problema de infraestrutura | Reportar com Request-ID para debug | ‚ùå N√£o |

### üéØ Decis√£o de Retry por Status Code

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Status 422 (Client Error)                      ‚îÇ
‚îÇ  ‚Üí Problema no input do cliente                 ‚îÇ
‚îÇ  ‚Üí ‚ùå N√ÉO RETRY (vai falhar de novo)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Status 502 (Bad Gateway)                       ‚îÇ
‚îÇ  ‚Üí Problema com servi√ßo externo (OpenAI)        ‚îÇ
‚îÇ  ‚Üí ‚úÖ RETRY (problema pode ser tempor√°rio)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Status 500 (Internal Error)                    ‚îÇ
‚îÇ  ‚Üí Problema interno da aplica√ß√£o                ‚îÇ
‚îÇ  ‚Üí ‚ùå N√ÉO RETRY (vai falhar de novo)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéì Exemplos Pr√°ticos

### Exemplo 1: Requisi√ß√£o Bem-Sucedida

```bash
curl -X POST http://localhost:8000/extract \
  -H "Content-Type: application/json" \
  -H "X-Request-ID: my-custom-id" \
  -d '{
    "transcript": "Cliente: Ol√°, preciso de um empr√©stimo de R$ 500 mil...",
    "metadata": {
      "meeting_id": "MTG-2025-001",
      "customer_id": "CUST-456",
      "meet_date": "2025-09-10T14:30:00Z"
    }
  }'
```

**Resposta:**

```http
HTTP/1.1 200 OK
Content-Type: application/json
X-Request-ID: my-custom-id

{
  "meeting_id": "MTG-2025-001",
  "customer_id": "CUST-456",
  "customer_name": "Jo√£o Silva",
  "banker_name": "Pedro Falc√£o",
  "meet_type": "Empr√©stimo",
  "meet_date": "2025-09-10T14:30:00Z",
  "summary": "Reuni√£o focou em... (169 palavras)",
  "key_points": ["Cliente precisa de R$ 500k", "..."],
  "action_items": ["Preparar proposta", "..."],
  "topics": ["Empr√©stimo", "Capital de Giro"],
  "source": "lftm-challenge",
  "idempotency_key": "7e3e97ffd83f...",
  "transcript_ref": null,
  "duration_sec": null
}
```

---

### Exemplo 2: Erro de Valida√ß√£o (422)

```bash
curl -X POST http://localhost:8000/extract \
  -H "Content-Type: application/json" \
  -d '{
    "transcript": "...",
    "raw_meeting": {...}
  }'
```

**Resposta:**

```http
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json
X-Request-ID: a1b2c3d4-...

{
  "error": "validation_error",
  "message": "Dados de entrada inv√°lidos",
  "details": [
    {
      "loc": ["body"],
      "msg": "Value error, Forne√ßa 'transcript' OU 'raw_meeting', n√£o ambos nem nenhum",
      "type": "value_error"
    }
  ],
  "request_id": "a1b2c3d4-..."
}
```

---

### Exemplo 3: Erro de Comunica√ß√£o com OpenAI (502)

```bash
curl -X POST http://localhost:8000/extract \
  -H "Content-Type: application/json" \
  -d '{
    "transcript": "Cliente: Ol√°..."
  }'
```

**Resposta (se OpenAI estiver com rate limit):**

```http
HTTP/1.1 502 Bad Gateway
Content-Type: application/json
X-Request-ID: xyz-789

{
  "error": "openai_communication_error",
  "message": "Erro ao comunicar com OpenAI API (timeout, rate limit ou indisponibilidade). Tente novamente em alguns instantes.",
  "error_type": "RateLimitError",
  "request_id": "xyz-789"
}
```

---

### Exemplo 4: Erro de Resposta Inv√°lida da OpenAI (502)

```bash
curl -X POST http://localhost:8000/extract \
  -H "Content-Type: application/json" \
  -d '{
    "transcript": "aksdjfh asdkjfh lkjasdhf asdkjfh..."
  }'
```

**Resposta (se OpenAI retornar dados inv√°lidos):**

```http
HTTP/1.1 502 Bad Gateway
Content-Type: application/json
X-Request-ID: abc-456

{
  "error": "openai_invalid_response",
  "message": "OpenAI retornou dados inv√°lidos ou incompletos. Tente novamente ou verifique se a transcri√ß√£o est√° leg√≠vel.",
  "request_id": "abc-456"
}
```

**Nota:** Mesmo status code (502), mas o campo `error` diferencia os tipos de problema

---

## üìñ Documenta√ß√£o Autom√°tica

FastAPI gera documenta√ß√£o autom√°tica baseada nos schemas e docstrings:

### Swagger UI (Interativo)

**URL:** http://localhost:8000/docs

**Caracter√≠sticas:**
- ‚úÖ Interface interativa ("Try it out")
- ‚úÖ Exemplos de requisi√ß√£o/resposta
- ‚úÖ Valida√ß√£o em tempo real
- ‚úÖ Autentica√ß√£o (se configurada)

![Swagger UI Example](https://fastapi.tiangolo.com/img/index/index-01-swagger-ui-simple.png)

### ReDoc (Naveg√°vel)

**URL:** http://localhost:8000/redoc

**Caracter√≠sticas:**
- ‚úÖ Vis√£o mais limpa e naveg√°vel
- ‚úÖ Melhor para leitura/impress√£o
- ‚úÖ Suporte a markdown nas descri√ß√µes

---

## üîç Debugging

### Como debugar requisi√ß√µes?

1. **Obtenha o Request-ID da resposta:**

```bash
curl -i http://localhost:8000/extract ...
# Header: X-Request-ID: abc-123
```

2. **Filtre logs por Request-ID:**

```bash
grep "abc-123" logs.txt
```

3. **Analise a sequ√™ncia de logs:**

```
[abc-123] POST /extract | format=transcript+metadata
[abc-123] Input normalizado | transcript_len=790
[abc-123] Iniciando extra√ß√£o | has_metadata=sim
[abc-123] LLM respondeu | output_keys=[...]
[abc-123] Valida√ß√£o OK
[abc-123] Extra√ß√£o conclu√≠da | meeting_id=MTG001
```

---

## üí° Dicas e Boas Pr√°ticas

### 1. Sempre valide a entrada com Pydantic

```python
# ‚úÖ BOM - Pydantic valida automaticamente
@app.post("/extract")
async def extract(body: ExtractRequest):
    # body j√° est√° validado aqui
    pass

# ‚ùå RUIM - Sem valida√ß√£o
@app.post("/extract")
async def extract(request: Request):
    body = await request.json()
    # body pode ter qualquer formato!
    pass
```

### 2. Use async/await para opera√ß√µes I/O

```python
# ‚úÖ BOM - Ass√≠ncrono (n√£o bloqueia)
@app.post("/extract")
async def extract(body: ExtractRequest):
    result = await extract_meeting_chain(...)
    return result

# ‚ùå RUIM - S√≠ncrono (bloqueia thread)
@app.post("/extract")
def extract(body: ExtractRequest):
    result = extract_meeting_chain_sync(...)
    return result
```

### 3. Sempre logue Request-ID

```python
# ‚úÖ BOM - Rastre√°vel
logger.info(f"[{request_id}] Processando...")

# ‚ùå RUIM - N√£o rastre√°vel
logger.info("Processando...")
```

### 4. Retorne c√≥digos HTTP apropriados

```python
# ‚úÖ BOM - C√≥digo espec√≠fico
if error_da_openai:
    return JSONResponse(status_code=502, ...)

# ‚ùå RUIM - Sempre 500
if any_error:
    return JSONResponse(status_code=500, ...)
```

---

## üìö Refer√™ncias

- **FastAPI Docs:** https://fastapi.tiangolo.com/
- **Starlette (base do FastAPI):** https://www.starlette.io/
- **HTTP Status Codes:** https://httpstatuses.com/

---

## üìù Resumo

O `main.py` √© respons√°vel por:

1. ‚úÖ Expor endpoints HTTP (`/health`, `/extract`)
2. ‚úÖ Validar entrada automaticamente (Pydantic)
3. ‚úÖ Adicionar Request-ID para rastreamento (middleware)
4. ‚úÖ Tratar erros de forma robusta (3 tipos espec√≠ficos + handlers globais)
5. ‚úÖ Gerar documenta√ß√£o autom√°tica (Swagger/ReDoc)
6. ‚úÖ Integrar todas as camadas (schemas + extractor)

### üîó Componentes Relacionados

- **Schemas:** [02-SCHEMAS.md](02-SCHEMAS.md) - Valida√ß√£o de dados (ExtractRequest, ExtractedMeeting)
- **Extractor:** [03-EXTRACTOR.md](03-EXTRACTOR.md) - L√≥gica de chamada √† OpenAI
- **Docker:** [DOCKER.md](DOCKER.md) - Como executar a aplica√ß√£o

### üìä Diagrama de Arquitetura Completa

O diagrama **"Arquitetura Completa: Vis√£o End-to-End"** neste documento (se√ß√£o üîÑ Fluxo de Requisi√ß√£o Completo) mostra:
- ‚úÖ Fluxo completo: Cliente ‚Üí FastAPI ‚Üí Extractor ‚Üí OpenAI ‚Üí Resposta
- ‚úÖ Pontos de valida√ß√£o (entrada e sa√≠da)
- ‚úÖ Tratamento de erros em cada camada
- ‚úÖ Responsabilidades de cada componente

---

**Navega√ß√£o:**
- ‚¨ÖÔ∏è **Anterior:** [03-EXTRACTOR.md](03-EXTRACTOR.md) - L√≥gica de extra√ß√£o
- ‚¨ÜÔ∏è **√çndice:** [01-OVERVIEW.md](01-OVERVIEW.md) - Vis√£o geral do sistema

